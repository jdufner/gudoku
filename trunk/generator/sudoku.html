<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <title>Sudoku 2010-02</title>
    <meta name="author" content="Jürgen Dufner"/>
    <meta name="description" content="Sudoku"/>
    <meta name="keywords" content="Sudoku"/>
    <meta http-equiv="content-type" content="text/html; charset=ISO-8859-15"/>
    <style type="text/css">
<!--
* {
  font-family: Verdana, Arial, Helvetica, sans-serif;
}
table#board.solved {
  border: #00ff00 solid 2px;
}
td.fixed {
  font-size: 15px;
  font-weight: bold;
  text-align: center;
  vertical-align: middle;
  border: #999999 solid 1px;
  width: 40px;
  min-width: 40px;
  max-width: 40px;
  height: 40px;
  min-height: 40px;
  max-height: 40px;
  margin: 0px;
  padding: 0px;
  cursor: default;
}
td.candidate {
  font-size: 9px;
  font-weight: normal; 
  text-align: center;
  vertical-align: middle;
  width: 13px;
  min-width: 13px;
  max-width: 13px;
  height: 13px;
  min-height: 13px;
  max-height: 13px;
  cursor: default;
}
td.block1, td.block3, td.block5, td.block7, td.block9 {
  background-color: #FFFFFF;
}
td.block2, td.block4, td.block6, td.block8 {
  background-color: #CCCCCC;
}
td.original {
  color: #0000ff;
}
td.conflict {
  border: #ff0000 solid 1px;
}
/* Kandidaten per Knopf hervorheben */
td.highlight1 {
  background-color: #ffff99; /* gelb */
}
/* Kandidaten onmouseover / onmouseout */
td.highlight2 {
  background-color: #ff9999; /* rot */
}
/* Fixed / Zellen */
td.highlight3 {
  background-color: #99ff99; /* gruen */
}
td.hide {
  visibility: hidden;
}
div.candidateButtonOff {
  margin: 2px;
  padding: 2px;
  border: 2px #999999 outset;
  background-color: #ffff99;
  cursor: default;
}
div.candidateButtonOn {
  margin: 2px;
  padding: 2px;
  border: 2px #999999 inset;
  background-color: #cccc99;
  cursor: default;
}
-->
    </style>
  </head>
  <body>
    <h1>Sudoku 2010-02</h1>
    <div id="sudoku" style="float:left"></div>
    <div style="float:left; margin-left:10px;">
      <fieldset>
        <legend>Statistik</legend>
        <p>Gesetzte Zellen: <input id="fixedCellNumber" style="float:right;" type="text" size="3" readonly="true" value=""/></p>
        <p>Verbleibende Kandidaten: <input id="candidateNumber" style="float:right;" type="text" size="3" readonly="true" value=""/></p>
      </fieldset>
    </div>
    <div id="candidateButtons" style="float:left; margin-left:10px;"></div>
    <div id="buttons" style="clear:both; margin-top:10px;">
      <select id="quests" name="quests" size="1">
        <option value=".......8......9.3...7.4.......5..6..7...2..1.268........17....4..3....27..9..6...">26740 leicht</option>
        <option value="2......3....8...5.....91..891..........3..9...8...62....3..2.8...56...4.....4....">27084 leicht</option>
        <option value="...4.....2....7.16.9..8...2.6....9..1.7...52..48.....14.....7.9.8...........2..38">27188 sehr leicht</option>
        <option value="..1.4.....9.....6...7....35..8.7...2.4651....9........3..7.....18..6.4.......5...">27701 mittel</option>
        <option value="1..7......8..6...43..1....5..6....9......24..9.....37..5.4.....81..59..2.........">28072 mittel</option>
        <option value="....6.2..8..7.....5...2.7..4......53...89...7......1....9....32...3...8...6..1...">28502 sehr schwer</option>
        <option value=".9.....3..82...61........2...89........7.8..163.........5.....9...17..4....32...5">28670 mittel</option>
        <option value=".718...2.5..2...34.....4.....8...1.6..4...5.....3.7.......6....8...41....9.......">28702 leicht</option>
        <option value="9..5...3...78...........186.3..8..9..61..4....8...2....9......1...3.......4..6..2">29687 mittel</option>
        <option value="1....9...2....3..1..7....5..1...63.......8.9...6.1...........7478......9....41.2.">30658 mittel</option>
        <option value=".81..2.......8.3.....1..9.43.....2.......9...2.....74....37..9.......1...26..4...">31415 leicht</option>
        <option value=".5...981..9.........4...5......2..9....483.2..43............7...69.3....3.5..1.6.">33107 schwer</option>
        <option value="2..5...6.9..1...........1...5....7.3..4..2..5....9...1...47....1..........2..349.">33297 leicht</option>
        <option value="....5.............23...9.58..6..1....1...362.7.4...3.....74..........1...528.....">34502 leicht</option>
        <option value="3...8.....8....3...5...9..14.9.....3.........8..5.37......61...6.....54.....9..8.">35629 sehr schwer</option>
        <option value="5.......4.....7....8..6..2.8.........921.......5.4.68..2..8.1...4...9..7.......6.">36299 sehr schwer</option>
        <option value="....91.5......4..9.16..8..4...6......89.4......3.85.9........3.4.......77.....81.">36327 schwer</option>
        <option value="...6...4...71..38.....5......3.....21...2......4..75...75.1...34...7.2.....3....1">37655 schwer</option>
        <option value="..2..1...1..49....5......8....9...4......2..1....5...9..51.73...84......2.....8..">39234 mittel</option>
        <option value="...23.......9...7...4...9.........5...9.....27...54...3.58.......2.9.4...6....2.3">40215 sehr schwer</option>
        <option value="..76.....3......5.....94...........1..1..9.2....3.6..585..7..3..4...5..27..42....">40364 schwer</option>
        <option value="5..3.1...6...8......4.5...6..5....3..1.....9.7......5.37...2...9.2..6.......478..">41531 sehr leicht</option>
        <option value="3.2..........7.........8.4.1......3.6..35...2..8..4....916.......4.2.6.7.......8.">42254 sehr schwer</option>
        <option value=".5..3...8..6....4...3..........56....8.........41.3.6.5..69.....9..8.........74.3">42798 sehr schwer</option>
        <option value=".59.....3...2.6.....4.......3......168...9...4.....89......84.681....5.....53...2">45850 sehr leicht</option>
        <option value=".7.9.6.2......3.....9...547.....17...1........6.....8.......17.4..5..3.99..3....2">48013 sehr leicht</option>
        <option value=".35...6....4..3........2.8.7...3.8.4...8........5...262.....1.34....6....68......">48383 schwer</option>
        <option value="9.....4..7...8.......16...5..1.4..2.5...2....83...57.....3............6.17.6..9.3">48975 sehr leicht</option>
        <option value="..1..9.........9.28.......6....3..5413..6......42.....9..8.......5..4..9.7....2.8">49908 schwer</option>
        <option value="...26.9.78.........5..8...4...32..1..........1.8..6.49....18......7...2...1...35.">53933 sehr leicht</option>
      </select>
      <input type="button" value="Laden" onclick="copyAndLoadSudoku()"/><br/>
      <input id="sudokuAsString" type="text" value="1382.5.7.2.783415.....1723838.5....1....2.58..5...8....2..8.3..913.5.84.876.4.9.5" size="81"/>
      <input id="incloseCandidates" type="checkbox">inkl. Kandidaten</input><input type="button" value="Laden" onclick="loadSudoku()"/><input type="button" value="Speichern" onclick="saveSudoku()"/><br/>
      <input type="button" value="Kandidaten entfernen" onclick="removeAllCandidates()"/><input type="button" value="Reset" onclick="resetAllCandidates()"/><input type="button" value="Leeren" onclick="emptyCandidates()"/><input id="hideButton" type="button" value="Ausblenden" onclick="hideCandidates()"/><br/>
      <input type="button" value="Aus Cookie laden" onclick="loadSudokuFromCookie()"/><input type="button" value="In Cookie speichern" onclick="saveSudokuInCookie()"/><br/>
      <input id="undoButton" type="button" value="&lt;&lt; Zurück &lt;&lt;" onclick="undoCommand();"><input id="doButton" type="button" value="&gt;&gt; Vor &gt;&gt;" onclick="doCommand();"><br/>
      <fieldset>
        <legend>Spielhilfe (<span id="configHelp" style="cursor:default;" onclick="switchVisibility('configHelp');">+</span>)</legend>
        <div id="configHelpBlock" style="visibility:hidden; display:none;">
          <input id="showConflicts" type="checkbox" checked="true">Fehler zeigen (funktioniert noch nicht)</input><br/>
        </div>
      </fieldset>
      <fieldset>
        <legend>Zellen (<span id="configCellHighlight" style="cursor:default;" onclick="switchVisibility('configCellHighlight');">+</span>)</legend>
        <div id="configCellHighlightBlock" style="visibility:hidden; display:none;">
          <input id="highlightFixed" type="checkbox" checked="true">Zellen hervorheben</input><br/>
          <input id="highlightAllFixed" type="checkbox">Auch andere Zellen hervorheben</input><br/>
          <input id="highlightAllFixedAndCandidates" type="checkbox">Auch andere Kandidaten hervorheben</input><br/>
        </div>
      </fieldset>
      <fieldset>
        <legend>Kandidaten (<span id="configCandidateHighlight" style="cursor:default;" onclick="switchVisibility('configCandidateHighlight');">+</span>)</legend>
        <div id="configCandidateHighlightBlock" style="visibility:hidden; display:none;">
          <input id="highlightCandidates" type="checkbox" checked="true">Kandidaten hervorheben</input><br/>
          <input id="highlightAllCandidates" type="checkbox">Auch andere Kandidaten hervorheben</input><br/>
          <input id="highlightAllCandidatesAndFixed" type="checkbox">Auch andere Zellen hervorheben</input><br/>
        </div>
      </fieldset>
      Kandidaten und andere Kandidaten hervorheben: Nach setzen einer Zelle, werden die anderen Zellen nicht zurückgesetzt.
    </div>
  </body>
  <script language="javascript">
<!--
var size = 9;
var subSize = 3;
var original;
var doCmd = new Array();
var undoCmd = new Array();
var updateStatisticsId;

function main() {
  buildBoard();
  buildCandidateButtons();
}

function command(cmdClass, cellNumber, candidateNumber) {
  this.cmdClass = cmdClass;
  this.cellNumber = cellNumber;
  this.candidateNumber = candidateNumber;
  this.candidateNumbers = null;
  this.execute = function() {
    if (cmdClass == "createCandidate") {
      createCandidateDo(cellNumber, candidateNumber);
    } else if (cmdClass == "removeCandidate") {
      removeCandidateDo(cellNumber, candidateNumber);
    } else if (cmdClass == "setCell") {
      this.candidateNumbers = getCandidateArray(cellNumber);
      promoteCandidateDo(cellNumber, candidateNumber);
    } else if (cmdClass == "unsetCell") {
      removeFixed(cellNumber, candidateNumber);
    } else {
      alert("Unbekannter Befehl: " + cmdClass);
    }
    updateStatisticsAsync();
  }
  this.unexecute = function() {
    if (cmdClass == "createCandidate") {
      removeCandidateDo(cellNumber, candidateNumber);
    } else if (cmdClass == "removeCandidate") {
      createCandidateDo(cellNumber, candidateNumber);
    } else if (cmdClass == "setCell") {
      buildCandidates(getCellId(cellNumber));
      var index = 0;
      for (var i = 1; i <= size; i++) {
        if (i == this.candidateNumbers[index]) {
          index++;
        } else {
          removeCandidateDo(cellNumber, i);
        }
      }
    } else if (cmdClass == "unsetCell") {
      promoteCandidateDo(cellNumber, candidateNumber);
    } else {
      alert("Unbekannter Befehl: " + cmdClass);
    }
    updateStatisticsAsync();
  }
}

function ableCmdButtons() {
  if (undoCmd.length <= 0) {
    document.getElementById("undoButton").disabled=true;
  } else {
    document.getElementById("undoButton").disabled=false;
  }
  if (doCmd.length <= 0) {
    document.getElementById("doButton").disabled=true;
  } else {
    document.getElementById("doButton").disabled=false;
  }
}

function createAndExecuteCmd(cmdClass, cellNumber, candidateNumber) {
  var cmd = new command(cmdClass, cellNumber, candidateNumber);
  cmd.execute();
  this.undoCmd.push(cmd);
  this.doCmd = new Array();
  ableCmdButtons();
}

function doCommand() {
  if (doCmd.length > 0) {
    var cmd = doCmd.pop();
    cmd.execute();
    undoCmd.push(cmd);
    ableCmdButtons();
  } else {
    alert("Es liegen keine Befehle zur Ausführung vor.");
  }
}

function undoCommand() {
  if (undoCmd.length > 0) {
    var cmd = undoCmd.pop();
    cmd.unexecute();
    doCmd.push(cmd);
    ableCmdButtons();
  } else {
    alert("Es liegen keine Rückgängig-Befehle zur Ausführung vor.");
  }
}

function updateStatisticsAsync() {
  if (updateStatisticsId != null) {
    clearTimeout(updateStatisticsId);
  }
  updateStatisticsId = setTimeout(updateStatistics, 100);
}

function updateStatistics() {
  var fixedCellNumber = 0;
  var candidateNumber = 0;
  for (var i = 1; i <= size * size; i++) {
    if (isCellFixed(i)) {
      fixedCellNumber++;
    } else {
      for (var k = 1; k <= size; k++) {
        var candidate = getCandidate(i, k);
        if (candidate.firstChild != null && candidate.firstChild.nodeType == 3) {
          candidateNumber++;
        }
      }
    }
    checkConflict(i);
  }
  document.getElementById("fixedCellNumber").value = fixedCellNumber;
  document.getElementById("candidateNumber").value = candidateNumber;
}

function switchVisibility(switchId) {
  var configSwitch = document.getElementById(switchId);
  var configSwitchBlock = document.getElementById(configSwitch.id + "Block");
  var content = configSwitch.firstChild.data;
  if (configSwitch.firstChild.data.match(/^\+$/)) {
    configSwitch.replaceChild(document.createTextNode("-"), configSwitch.firstChild);
    configSwitchBlock.style.visibility = "visible";
    configSwitchBlock.style.display = "block";
  } else {
    configSwitch.replaceChild(document.createTextNode("+"), configSwitch.firstChild);
    configSwitchBlock.style.visibility = "hidden";
    configSwitchBlock.style.display = "none";
  }
}

function addStyle(style, newStyle) {
  var erg = style.indexOf(newStyle);
  if (erg >= 0) {
    return style;
  } else {
    return style + " " + newStyle;
  }
}

function removeStyle(style, oldStyle) {
  var erg = style.indexOf(" " + oldStyle);
  if (erg >= 0) {
    return style.substr(0, erg);
  } else {
    return style;
  }
}

function getCell(cellId) {
  return document.getElementById(cellId);
}

function getCellId(cellNumber) {
  return "cell" + cellNumber;
}

function getCandidate(cellNumber, c) {
  return document.getElementById(getCandidateId(getCellId(cellNumber), c));
}

function getCandidateId(cellId, c) {
  return cellId + "candidate" + c;
}

function getColumnNumber(cellNumber) {
  column = cellNumber % size;
  if (column == 0) {
    return size;
  }
  return column;
}

function getBlockNumber(cellNumber) {
  row = getRowNumber(cellNumber);
  column = getColumnNumber(cellNumber);
  return Math.floor((row - 1)/ subSize) * subSize + Math.floor((column - 1)/ subSize) + 1;
}

function getFixedValue(cellNumber) {
  if (isCellFixed(cellNumber)) {
    return getValue(getCell(getCellId(cellNumber)));
  }
  return null;
}

function getRowNumber(cellNumber) {
  return Math.floor((cellNumber - 1)/ size) + 1;
}

function getValue(node) {
  return parseInt(node.firstChild.data);
}

function isCellFixed(cellNumber) {
  if (getCell(getCellId(cellNumber)).firstChild.nodeType == 3) {
    return true;
  }
  return false;
}

function buildBoard() {
  var boardTable = document.createElement("table");
  boardTable.id = "board";
  boardTable.border = "0";
  boardTable.cellPadding = "0";
  boardTable.cellSpacing = "0";
  document.getElementById("sudoku").appendChild(boardTable);
  var row = null;
  for (var i = 1; i <= size * size; i++) {
    if (i % size == 1) {
      var row = document.createElement("tr");
      row.id = "row" + (Math.floor(i / size) + 1);
      boardTable.appendChild(row);
    }
    var cell = document.createElement("td");
    cell.id = getCellId(i);
    cell.className = "fixed block" + getBlockNumber(i);
    row.appendChild(cell);
    var cellText = document.createTextNode(i);
    cell.appendChild(cellText);
  }
}

function buildCandidates(cellId) {
  cell = getCell(cellId);
  cell.className = removeStyle(cell.className, "original")
  cell.className = removeStyle(cell.className, "conflict")
  cell.className = removeStyle(cell.className, "highlight3")
  cell.onmouseover = null;
  cell.onmouseout = null;
  cell.onclick = null;
  cell.ondblclick = null;
  candidatesTable = document.createElement("table");
  candidatesTable.id = cellId + "candidate";
  candidatesTable.border = "0"
  candidatesTable.cellPadding = "0";
  candidatesTable.cellSpacing = "0";
  var candidatesRow = null;
  for (var i = 1; i <= size; i++) {
    if (i % subSize == 1) {
      candidatesRow = document.createElement("tr");
      candidatesRow.id = cellId + "row" + (Math.floor(i / subSize) + 1);
      candidatesTable.appendChild(candidatesRow);
    }
    candidatesCell = document.createElement("td");
    candidatesCell.id = getCandidateId(cellId, i);
    candidatesCell.className = "candidate";
    if (document.getElementById("candidateButton" + i).className.match(/candidateButtonOn/g)) {
      candidatesCell.className = addStyle(candidatesCell.className, "highlight1");
    }
    candidatesCell.onmouseover = enterCandidate;
    candidatesCell.onmouseout = exitCandidate;
    candidatesCell.onclick = removeCandidate;
    candidatesCell.ondblclick = promoteCandidate;
    candidatesRow.appendChild(candidatesCell);
    cellText = document.createTextNode(i);
    candidatesCell.appendChild(cellText);
  }
  cell.replaceChild(candidatesTable, cell.firstChild);
}

function buildFixed(cellNumber, value) {
  cell = getCell(getCellId(cellNumber));
  cell.className = removeStyle(cell.className, "conflict")
  cell.onmouseover = enterFixed;
  cell.onmouseout = exitFixed;
  if (isInOriginal(cellNumber)) {
    cell.className = addStyle(cell.className, "original");
  } else {
    cell.className = removeStyle(cell.className, "original");
  }
  var cellText = document.createTextNode(value);
  cell.replaceChild(cellText, cell.firstChild);
}

function loadSudoku() {
  if (document.getElementById("sudokuAsString").value.match(/^[0-9\.]{81}$/)) {
    original = document.getElementById("sudokuAsString").value;
    for (var i = 1; i <= size * size; i++) {
      value = original.substr(i - 1, 1);
      if (value == ".") {
        buildCandidates(getCellId(i));
      } else {
        buildFixed(i, value);
      }
    }
  } else {
    if (!parseSudokuString(document.getElementById("sudokuAsString").value)) {
      alert("Sudoku ist ungültig!");
    }
  }
  updateStatisticsAsync();
}

function removeAllCandidates() {
  for (var i = 1; i <= size * size; i++) {
    if (isCellFixed(i)) {
      // Nix machen!
    } else {
      // Fixed aus Zeile, Spalte und Block sammeln
      removeCandidates(i);
    }
  }
}

function collectFixed(cellNumber) {
  var fixed = new Array();
  for (var i = 1; i <= size; i++) {
    fixed[i] = false;
  }
  for (var i = 1; i <= size * size; i++) {
    if (i != cellNumber) {
      if (getRowNumber(i) == getRowNumber(cellNumber)) {
        if (isCellFixed(i)) {
          fixed[getFixedValue(i)] = true;
        }
      }
      if (getColumnNumber(i) == getColumnNumber(cellNumber)) {
        if (isCellFixed(i)) {
          fixed[getFixedValue(i)] = true;
        }
      }
      if (getBlockNumber(i) == getBlockNumber(cellNumber)) {
        if (isCellFixed(i)) {
          fixed[getFixedValue(i)] = true;
        }
      }
    }
  }
  return fixed;
}

function removeCandidates(cellNumber) {
  var fixed = collectFixed(cellNumber);
  for (var i = 1; i <= size; i++) {
    if (fixed[i]) {
      var candidate = getCandidate(cellNumber, i);
      if (candidate.firstChild != null && candidate.firstChild.nodeType == 3) {
        createAndExecuteCmd("removeCandidate", cellNumber, i);
      }
    }
  }
}

function conflictsCandidate(cellNumber, c) {
  return collectFixed(cellNumber)[c];
}

function highlightFixedOn(value) {
  for (var i = 1; i <= size * size; i++) {
    if (isCellFixed(i)) {
      var cell = getCell(getCellId(i));
      if (value == getValue(cell)) {
        cell.className = addStyle(cell.className, "highlight3");
      }
    }
  }
}

function highlightFixedOff(value) {
  for (var i = 1; i <= size * size; i++) {
    if (isCellFixed(i)) {
      var cell = getCell(getCellId(i));
      if (value == getValue(cell)) {
        cell.className = removeStyle(cell.className, "highlight3");
      }
    }
  }
}

function enterFixed() {
  var value = getValue(this);
  if (document.getElementById("highlightFixed").checked) {
    this.className = addStyle(this.className, "highlight3");
  }
  if (document.getElementById("highlightAllFixed").checked) {
    highlightFixedOn(value);
  }
  if (document.getElementById("highlightAllFixedAndCandidates").checked) {
    highlightCandidateOn(value, "highlight2");
  }
}

function exitFixed() {
  var value = getValue(this);
  this.className = removeStyle(this.className, "highlight3");
  highlightFixedOff(value);
  highlightCandidateOff(value, "highlight2");
}

function enterCandidate() {
  var value = getValue(this);
  if (document.getElementById("highlightCandidates").checked) {
    this.className = addStyle(this.className, "highlight2");
  }
  if (document.getElementById("highlightAllCandidates").checked) {
    highlightCandidateOn(value, "highlight2");
  }
  if (document.getElementById("highlightAllCandidatesAndFixed").checked) {
    highlightFixedOn(value);
  }
}

function exitCandidate() {
  var value = getValue(this);
  this.className = removeStyle(this.className, "highlight2");
  highlightCandidateOff(value, "highlight2");
  highlightFixedOff(value);
}

function removeCandidateDo(cellNumber, candidateNumber) {
  var candidate = getCandidate(cellNumber, candidateNumber);
  if (candidate.firstChild == null || candidate.firstChild.data.length <= 0) {
    return;
  }
  candidate.className = removeStyle(candidate.className, "highlight1");
  candidate.className = removeStyle(candidate.className, "highlight2");
  candidate.onmouseover = null;
  candidate.onmouseout = null;
  //candidate.onclick = null;
  //candidate.ondblclick = null;
  candidate.removeChild(candidate.firstChild);
}

function createCandidateDo(cellNumber, candidateNumber) {
  var candidate = getCandidate(cellNumber, candidateNumber);
  candidate.className = "candidate";
  candidate.onmouseover = enterCandidate;
  candidate.onmouseout = exitCandidate;
  //candidate.onclick = removeCandidate;
  //candidate.ondblclick = promoteCandidate;
  if (isCandidateButtonOn(candidateNumber)) {
    candidate.className = addStyle(candidate.className, "highlight1");
  }
  candidateText = document.createTextNode(candidateNumber);
  candidate.appendChild(candidateText);
}

function createOrRemoveCandidateDo(candidateId) {
  var candidate = document.getElementById(candidateId);
  candidateId.match(/cell(\d+)candidate(\d+)/g);
  if (candidate.firstChild != null && candidate.firstChild.nodeType == 3) {
    createAndExecuteCmd("removeCandidate", parseInt(RegExp.$1), parseInt(RegExp.$2));
  } else {
    createAndExecuteCmd("createCandidate", parseInt(RegExp.$1), parseInt(RegExp.$2));
  }
}

function promoteCandidateDo(cellNumber, candidateNumber) {
  buildFixed(cellNumber, candidateNumber);
  var cellId = getCellId(cellNumber)
  var cell = document.getElementById(cellId);
  if (conflictsCandidate(cellNumber, candidateNumber)) {
    cell.className = addStyle(cell.className, "conflict");
  }
  cell.replaceChild(document.createTextNode(candidateNumber), cell.firstChild);
  cell.onclick = resetFixed;
  checkAllConflicts(cellNumber);
  if (isSolved()) {
    var board = document.getElementById("board");
    board.className = addStyle(board.className, "solved");
  }
}

var dblclick = false;

function removeCandidate() {
  var candidateId = this.id;
  setTimeout(function() {
    if (dblclick == true) {
      return;
    }
    createOrRemoveCandidateDo(candidateId);
  }, 250);
}

function promoteCandidate() {
  var candidateId = this.id;
  dblclick = true;
  candidateId.match(/cell(\d+)candidate(\d+)/g);
  createAndExecuteCmd("setCell", parseInt(RegExp.$1), parseInt(RegExp.$2));
  setTimeout(function() {
    dblclick = false;
  }, 250);
}

function buildCandidateButtons() {
  var candidateButtons = document.getElementById("candidateButtons");
  for (var i = 1; i <= size; i++) {
    var candidateButton = document.createElement("div");
    candidateButton.id = "candidateButton" + i;
    candidateButton.className = "candidateButtonOff";
    candidateButton.onclick = highlightCandidates;
    candidateButtons.appendChild(candidateButton);
    candidateButton.appendChild(document.createTextNode(i));
  }
}

function highlightCandidateOn(candidate, cssClassName) {
  for (var i = 1; i <= size * size; i++) {
    if (!isCellFixed(i)) {
      for (var k = 1; k <= size; k++) {
        var candidateNode = getCandidate(i, k);
        if (candidateNode.childNodes.length > 0 && candidateNode.firstChild.data.length > 0) {
          if (k == candidate) {
            candidateNode.className = addStyle(candidateNode.className, cssClassName);
          }
        }
      }
    }
  }
}

function highlightCandidateOff(candidate, cssClassName) {
  for (var i = 1; i <= size * size; i++) {
    if (!isCellFixed(i)) {
      for (var k = 1; k <= size; k++) {
        var candidateNode = getCandidate(i, k);
        if (candidateNode.childNodes.length > 0 && candidateNode.firstChild.data.length > 0) {
          if (k == candidate) {
            candidateNode.className = removeStyle(candidateNode.className, cssClassName);
          }
        }
      }
    }
  }
}

function highlightCandidates() {
  var candidate = parseInt(this.id.match(/\d+/g)[0]);
  if (this.className == "candidateButtonOff") {
    this.className = "candidateButtonOn";
    highlightCandidateOn(candidate, "highlight1");
  } else {
    this.className = "candidateButtonOff";
    highlightCandidateOff(candidate, "highlight1");
  }
}

function isCandidateButtonOn(value) {
  for (var i = 1; i <= size; i++) {
    var candidateButton = document.getElementById("candidateButton" + i);
    if (candidateButton.className.match(/candidateButtonOn/g)) {
      return true;
    }
  }
  return false;
}

function removeFixed(cellNumber, candidateNumber) {
  highlightFixedOff(candidateNumber);
  highlightCandidateOff(candidateNumber, "highlight2");
  if (isInOriginal(cellNumber)) {
    // Nix machen
  } else {
    // Reset
    buildCandidates(getCellId(cellNumber));
    checkAllConflicts(cellNumber);
  }
  if (!isSolved()) {
    var board = document.getElementById("board");
    board.className = removeStyle(board.className, "solved");
  }
}

function resetFixed() {
  var cellNumber = parseInt(this.id.match(/\d+/g)[0]);
  var value = getValue(this);
  createAndExecuteCmd("unsetCell", cellNumber, value);
}

function isInOriginal(cellNumber) {
  var originalChar = original.substr(cellNumber - 1, 1);
  if (originalChar.match(/\d+/)) {
    return true;
  }
  return false;
}

function resetAllCandidates() {
  for (var i = 1; i <= size * size; i++) {
    if (!isCellFixed(i)) {
      buildCandidates(getCellId(i));
    }
  }
}

function emptyCandidates() {
  for (var i = 1; i <= size * size; i++) {
    if (!isCellFixed(i)) {
      for (var k = 1; k <= size; k++) {
        removeCandidateDo(getCandidateId(getCellId(i), k));
      }
    }
  }
}

function copyAndLoadSudoku() {
  document.getElementById("sudokuAsString").value = document.getElementById("quests").value;
  loadSudoku();
}

function checkAllConflicts(cellNumber) {
  for (var i = 1; i <= size * size; i++) {
    if (getRowNumber(i) == getRowNumber(cellNumber)) {
      if (isCellFixed(i)) {
        checkConflict(i);
      }
    }
    if (getColumnNumber(i) == getColumnNumber(cellNumber)) {
      if (isCellFixed(i)) {
        checkConflict(i);
      }
    }
    if (getBlockNumber(i) == getBlockNumber(cellNumber)) {
      if (isCellFixed(i)) {
        checkConflict(i);
      }
    }
  }
}

function checkConflict(cellNumber) {
  var cellId = getCellId(cellNumber);
  var cell = document.getElementById(cellId);
  if (isCellFixed(cellNumber)) {
    if (conflictsCandidate(cellNumber, getFixedValue(cellNumber))) {
      cell.className = addStyle(cell.className, "conflict");
    } else {
      cell.className = removeStyle(cell.className, "conflict");
    }
  }
}

function hideCandidates() {
  var hideButton = document.getElementById("hideButton");
  if (hideButton.value == "Ausblenden") {
    //var stylesheets = document.styleSheets;
    for (var i = 1; i <= size * size; i++) {
      if (!isCellFixed(i)) {
        for (var k = 1; k <= size; k++) {
          var candidate = getCandidate(i, k);
          candidate.className = addStyle(candidate.className, "hide");
        }
      }
    }
    hideButton.value = "Einblenden";
  } else {
    for (var i = 1; i <= size * size; i++) {
      if (!isCellFixed(i)) {
        for (var k = 1; k <= size; k++) {
          var candidate = getCandidate(i, k);
          candidate.className = removeStyle(candidate.className, "hide");
        }
      }
    }
    hideButton.value = "Ausblenden";
  }
}

function saveSudoku() {
  var sudokuAsString = buildSudokuString(false);
  document.getElementById("sudokuAsString").value = sudokuAsString;
}

function isSolved() {
  var sum = (size * (size + 1)) / 2;
  var rowSum = new Array();
  var columnSum = new Array();
  var blockSum = new Array();
  for (var i = 1; i <= size; i++) {
    rowSum[i] = 0;
    columnSum[i] = 0;
    blockSum[i] = 0;
  }
  for (var i = 1; i <= size * size; i++) {
    if (isCellFixed(i)) {
      rowSum[getRowNumber(i)] = rowSum[getRowNumber(i)] + getFixedValue(i);
      columnSum[getColumnNumber(i)] = columnSum[getColumnNumber(i)] + getFixedValue(i);
      blockSum[getBlockNumber(i)] = blockSum[getBlockNumber(i)] + getFixedValue(i);
    }
  }
  for (var i = 1; i <= size; i++) {
    if (rowSum[i] != sum) {
      return false;
    }
    if (columnSum[i] != sum) {
      return false;
    }
    if (blockSum[i] != sum) {
      return false;
    }
  }
  return true;
}

function eraseCookie() {
  var name = "SudokuAsString";
  var domain = null; //"jdufner.de";
  var expires = new Date((new Date()).getTime() - 1000*3600*24).toGMTString();
  var path = null;
  //var secure = null;
  var cook = name + "=";
  cook += (domain) ? "; domain=" + domain : "";
  cook += (expires) ? "; expires=" + expires : "";
  cook += (path) ? "; path=" + path : "";
  //cook += (secure) ? "; secure" : "";
  document.cookie = cook;
}

function setCookie(wert) {
  var name = "SudokuAsString";
  var domain = null; //"jdufner.de";
  var expires = new Date((new Date()).getTime() + 1000*3600*24*7).toGMTString();
  var path = null;
  //var secure = null;
  var cook = name + "=" + unescape(wert);
  cook += (domain) ? "; domain=" + domain : "";
  cook += (expires) ? "; expires=" + expires : "";
  cook += (path) ? "; path=" + path : "";
  //cook += (secure) ? "; secure" : "";
  document.cookie = cook;
}

function getCookie() {
  var name = "SudokuAsString";
  var i = 0;  //Suchposition im Cookie
  var suche = name + "=";
  while (i < document.cookie.length) {
    if (document.cookie.substring(i, i + suche.length) == suche) {
      var ende = document.cookie.indexOf(";", i + suche.length);
      if (ende <= -1) {
        ende = document.cookie.length;
      }
      var cook = document.cookie.substring(i + suche.length, ende);
      return unescape(cook);
    }
    i++;
  }
  return "";
}

function getCandidateArray(cellNumber) {
  var candidates = new Array();
  for (var i = 1; i <= size; i++) {
    var candidate = getCandidate(cellNumber, i);
    if (candidate.firstChild != null && candidate.firstChild.nodeType == 3) {
      candidates.push(i);
    }
  }
  return candidates;
}

function buildCandidateString(cellNumber) {
  return getCandidateArray(cellNumber).join("-");
}

function buildSudokuString(forceIncloseCandidates) {
  var sudoku = new Array();
  var incloseCandidates = document.getElementById("incloseCandidates").checked;
  for (var i = 1; i <= size * size; i++) {
    if (isCellFixed(i)) {
      sudoku[i-1] = getFixedValue(i);
    } else {
      if (forceIncloseCandidates || incloseCandidates) {
        sudoku[i-1] = buildCandidateString(i);
      } else {
        sudoku[i-1] = ".";
      }
    }
  }
  if (forceIncloseCandidates || incloseCandidates) {
    return sudoku.join(",");
  } else {
    return sudoku.join("");
  }
}

function saveSudokuInCookie() {
  var sudokuString = buildSudokuString(true);
  if (sudokuString.length > 4000) {
    alert("Sudoku kann nicht gespeichert werden");
  }
  setCookie(sudokuString);
}

function parseSudokuString(sudokuString) {
  var sudoku = sudokuString.split(",");
  original = "";
  for (var i = 1; i <= size * size; i++) {
    if (sudoku[i-1].match(/^(\d+)$/)) {
      // fixed
      original += parseInt(RegExp.$1);
    } else {
      // candidates
      original += ".";
    }
  }
  for (var i = 1; i <= size * size; i++) {
    if (sudoku[i-1].match(/^(\d+)$/)) {
      // fixed
      buildFixed(i, parseInt(RegExp.$1));
    } else {
      // candidates
      if (sudoku[i-1].match(/^([0-9\-]+)$/)) {
        var candidates = sudoku[i-1].split("-");
        var cellId = getCellId(i);
        buildCandidates(cellId);
        var candidate = parseInt(candidates.shift());
        for (var k = 1; k <= size; k++) {
          if (k != candidate) {
            removeCandidateDo(i, k);
          } else {
            candidate = parseInt(candidates.shift());
          }
        }
      } else {
        return false;
      }
    }
  }
  return true;
}

function loadSudokuFromCookie() {
  var sudokuString = getCookie();
  parseSudokuString(sudokuString);
  updateStatisticsAsync();
}

main();

-->
  </script>
</html>
